{% extends "base.html" %}

{% block title %}Admin Dashboard - Job Monitor{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    .dashboard-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #333;
    }
    
    .stat-subtitle {
        color: #999;
        font-size: 0.85rem;
        margin-top: 5px;
    }
    
    .chart-section {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .chart-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .api-quota-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .quota-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
    }
    
    .quota-card.unlimited {
        border-left-color: #48bb78;
    }
    
    .quota-card.warning {
        border-left-color: #ed8936;
    }
    
    .quota-card.error {
        border-left-color: #f56565;
    }
    
    .quota-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
    }
    
    .quota-stats {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
    }
    
    .quota-stat {
        text-align: center;
    }
    
    .quota-stat-label {
        font-size: 0.75rem;
        color: #999;
        text-transform: uppercase;
    }
    
    .quota-stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
        margin-top: 5px;
    }
    
    .loading {
        text-align: center;
        padding: 50px;
        color: #999;
    }
    
    .refresh-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.2s;
    }
    
    .refresh-btn:hover {
        background: #5568d3;
    }
    
    .table-container {
        overflow-x: auto;
    }
    
    .top-list {
        list-style: none;
        padding: 0;
    }
    
    .top-list li {
        padding: 10px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .top-list li:last-child {
        border-bottom: none;
    }
    
    .top-list .rank {
        background: #667eea;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.85rem;
        margin-right: 15px;
    }
    
    .top-list .name {
        flex: 1;
        font-weight: 500;
    }
    
    .top-list .count {
        background: #f7fafc;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: 600;
        color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 style="margin: 0 0 10px 0; font-size: 2rem;">üìä Admin Dashboard</h1>
        <p style="margin: 0; opacity: 0.9;">Real-time monitoring and statistics for Job Monitor</p>
        <button class="refresh-btn" onclick="loadStats()" style="margin-top: 15px;">
            üîÑ Refresh Data
        </button>
    </div>
    
    <div id="loading" class="loading">
        <h3>Loading statistics...</h3>
    </div>
    
    <div id="dashboard-content" style="display: none;">
        <!-- Key Metrics -->
        <div class="stats-grid" id="key-metrics">
            <!-- Will be populated by JavaScript -->
        </div>
        
        <!-- API Quotas -->
        <h2 style="margin: 30px 0 20px 0; color: #333;">üîë API Quotas</h2>
        <div class="api-quota-grid" id="api-quotas">
            <!-- Will be populated by JavaScript -->
        </div>
        
        <!-- Charts Row -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
            <div class="chart-section">
                <h3 class="chart-title">Jobs by Source</h3>
                <canvas id="jobsBySourceChart"></canvas>
            </div>
            
            <div class="chart-section">
                <h3 class="chart-title">Match Quality Distribution</h3>
                <canvas id="matchDistributionChart"></canvas>
            </div>
        </div>
        
        <!-- Jobs Timeline -->
        <div class="chart-section">
            <h3 class="chart-title">Jobs Discovered (Last 30 Days)</h3>
            <canvas id="jobsTimelineChart"></canvas>
        </div>
        
        <!-- Top Lists -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <div class="chart-section">
                <h3 class="chart-title">Top Companies</h3>
                <ul class="top-list" id="top-companies-list">
                    <!-- Will be populated by JavaScript -->
                </ul>
            </div>
            
            <div class="chart-section">
                <h3 class="chart-title">Top Locations</h3>
                <ul class="top-list" id="top-locations-list">
                    <!-- Will be populated by JavaScript -->
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
let charts = {};

async function loadStats() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('dashboard-content').style.display = 'none';
    
    try {
        const response = await fetch('/api/stats');
        const stats = await response.json();
        
        renderKeyMetrics(stats);
        renderAPIQuotas(stats.api_quotas);
        renderCharts(stats);
        renderTopLists(stats);
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dashboard-content').style.display = 'block';
    } catch (error) {
        console.error('Error loading stats:', error);
        document.getElementById('loading').innerHTML = '<h3 style="color: #f56565;">Error loading statistics. Please try again.</h3>';
    }
}

function renderKeyMetrics(stats) {
    const metricsHtml = `
        <div class="stat-card">
            <div class="stat-label">Total Jobs</div>
            <div class="stat-value">${stats.total_jobs.toLocaleString()}</div>
            <div class="stat-subtitle">+${stats.jobs_today} today</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Total Matches</div>
            <div class="stat-value">${stats.total_matches.toLocaleString()}</div>
            <div class="stat-subtitle">+${stats.matches_today} today</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Users</div>
            <div class="stat-value">${stats.total_users}</div>
            <div class="stat-subtitle">${stats.total_cvs} CVs uploaded</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Claude Analyses</div>
            <div class="stat-value">${stats.claude_analyses_total.toLocaleString()}</div>
            <div class="stat-subtitle">$${stats.claude_estimated_cost.toFixed(2)} estimated cost</div>
        </div>
    `;
    document.getElementById('key-metrics').innerHTML = metricsHtml;
}

function renderAPIQuotas(quotas) {
    let html = '';
    
    // JSearch
    if (quotas.jsearch) {
        const jsearch = quotas.jsearch;
        let cardClass = 'quota-card';
        let status = '‚úÖ Active';
        
        if (!jsearch.available) {
            cardClass += ' error';
            status = '‚ùå Not Configured';
        } else if (jsearch.error) {
            cardClass += ' warning';
            status = '‚ö†Ô∏è Unable to fetch quota';
        }
        
        html += `
            <div class="${cardClass}">
                <div class="quota-name">JSearch API ${status}</div>
                <div class="quota-stats">
                    <div class="quota-stat">
                        <div class="quota-stat-label">Remaining</div>
                        <div class="quota-stat-value">${jsearch.requests_remaining || 'N/A'}</div>
                    </div>
                    <div class="quota-stat">
                        <div class="quota-stat-label">Limit</div>
                        <div class="quota-stat-value">${jsearch.requests_limit || 'N/A'}</div>
                    </div>
                </div>
                ${jsearch.error ? `<div style="margin-top: 10px; color: #999; font-size: 0.85rem;">Check RapidAPI dashboard for details</div>` : ''}
            </div>
        `;
    }
    
    // Active Jobs
    if (quotas.activejobs) {
        const aj = quotas.activejobs;
        let cardClass = 'quota-card';
        let status = '‚úÖ Active';
        
        if (!aj.available) {
            cardClass += ' error';
            status = '‚ùå Not Configured';
        } else if (aj.error) {
            cardClass += ' warning';
            status = '‚ö†Ô∏è Unable to fetch quota';
        }
        
        html += `
            <div class="${cardClass}">
                <div class="quota-name">Active Jobs DB ${status}</div>
                <div class="quota-stats">
                    <div class="quota-stat">
                        <div class="quota-stat-label">Remaining</div>
                        <div class="quota-stat-value">${aj.requests_remaining || 'N/A'}</div>
                    </div>
                    <div class="quota-stat">
                        <div class="quota-stat-label">Limit</div>
                        <div class="quota-stat-value">${aj.requests_limit || 'N/A'}</div>
                    </div>
                </div>
                ${aj.error ? `<div style="margin-top: 10px; color: #999; font-size: 0.85rem;">Check RapidAPI dashboard for details</div>` : ''}
            </div>
        `;
    }
    
    // Arbeitsagentur
    if (quotas.arbeitsagentur) {
        html += `
            <div class="quota-card unlimited">
                <div class="quota-name">Arbeitsagentur ‚úÖ Active</div>
                <div class="quota-stats">
                    <div class="quota-stat">
                        <div class="quota-stat-label">Remaining</div>
                        <div class="quota-stat-value">‚àû</div>
                    </div>
                    <div class="quota-stat">
                        <div class="quota-stat-label">Limit</div>
                        <div class="quota-stat-value">‚àû</div>
                    </div>
                </div>
                <div style="margin-top: 10px; color: #48bb78; font-size: 0.85rem;">Free German government API</div>
            </div>
        `;
    }
    
    document.getElementById('api-quotas').innerHTML = html;
}

function renderCharts(stats) {
    // Destroy existing charts
    Object.values(charts).forEach(chart => chart.destroy());
    charts = {};
    
    // Jobs by Source Chart
    if (stats.jobs_by_source && stats.jobs_by_source.length > 0) {
        const ctx1 = document.getElementById('jobsBySourceChart').getContext('2d');
        charts.jobsBySource = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: stats.jobs_by_source.map(item => item.source),
                datasets: [{
                    data: stats.jobs_by_source.map(item => item.count),
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#4facfe',
                        '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }
    
    // Match Distribution Chart
    if (stats.match_distribution && stats.match_distribution.length > 0) {
        const ctx2 = document.getElementById('matchDistributionChart').getContext('2d');
        charts.matchDistribution = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: stats.match_distribution.map(item => item.range),
                datasets: [{
                    label: 'Matches',
                    data: stats.match_distribution.map(item => item.count),
                    backgroundColor: ['#48bb78', '#4299e1', '#ed8936', '#f56565']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Jobs Timeline Chart
    if (stats.jobs_by_date && stats.jobs_by_date.length > 0) {
        const ctx3 = document.getElementById('jobsTimelineChart').getContext('2d');
        charts.jobsTimeline = new Chart(ctx3, {
            type: 'line',
            data: {
                labels: stats.jobs_by_date.map(item => item.date).reverse(),
                datasets: [{
                    label: 'Jobs Discovered',
                    data: stats.jobs_by_date.map(item => item.count).reverse(),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
}

function renderTopLists(stats) {
    // Top Companies
    if (stats.top_companies && stats.top_companies.length > 0) {
        const companiesHtml = stats.top_companies.map((item, idx) => `
            <li>
                <span class="rank">${idx + 1}</span>
                <span class="name">${item.company || 'Unknown'}</span>
                <span class="count">${item.count}</span>
            </li>
        `).join('');
        document.getElementById('top-companies-list').innerHTML = companiesHtml;
    }
    
    // Top Locations
    if (stats.top_locations && stats.top_locations.length > 0) {
        const locationsHtml = stats.top_locations.map((item, idx) => `
            <li>
                <span class="rank">${idx + 1}</span>
                <span class="name">${item.location}</span>
                <span class="count">${item.count}</span>
            </li>
        `).join('');
        document.getElementById('top-locations-list').innerHTML = locationsHtml;
    }
}

// Load stats on page load
loadStats();

// Auto-refresh every 2 minutes
setInterval(loadStats, 120000);
</script>
{% endblock %}
