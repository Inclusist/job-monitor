{% extends "base.html" %}

{% block title %}Running Search - Job Monitor{% endblock %}

{% block content %}
<div class="card">
    <h2>üîç Job Search in Progress</h2>
    <p>Searching for jobs matching your criteria...</p>
    
    <div style="margin: 2rem 0;">
        <div style="background: #f0f0f0; border-radius: 8px; height: 30px; overflow: hidden; position: relative;">
            <div id="progress-bar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
            <div id="progress-text" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 600; color: #333;">0%</div>
        </div>
    </div>
    
    <div id="status-container" style="background: #f8f9fa; border-radius: 8px; padding: 1.5rem; min-height: 300px; max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">
        <div id="status-messages"></div>
    </div>
    
    <div id="completion-message" style="display: none; margin-top: 2rem;">
        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 1.5rem; color: #155724;">
            <h3 style="margin: 0 0 0.5rem 0;">‚úÖ Search Complete!</h3>
            <p id="completion-text" style="margin: 0;"></p>
            <a href="{{ url_for('jobs') }}" class="btn" style="margin-top: 1rem; background: #28a745;">View Results</a>
        </div>
    </div>
    
    <div id="error-message" style="display: none; margin-top: 2rem;">
        <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 1.5rem; color: #721c24;">
            <h3 style="margin: 0 0 0.5rem 0;">‚ùå Search Error</h3>
            <p id="error-text" style="margin: 0;"></p>
            <a href="{{ url_for('jobs') }}" class="btn btn-secondary" style="margin-top: 1rem;">Go Back</a>
        </div>
    </div>
</div>

<script>
    const eventSource = new EventSource("{{ url_for('search_stream') }}");
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const statusMessages = document.getElementById('status-messages');
    const completionMessage = document.getElementById('completion-message');
    const completionText = document.getElementById('completion-text');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    
    function addStatusMessage(message, type = 'info') {
        const msgDiv = document.createElement('div');
        msgDiv.style.marginBottom = '0.5rem';
        msgDiv.style.padding = '0.5rem';
        msgDiv.style.borderRadius = '4px';
        
        if (type === 'success') {
            msgDiv.style.background = '#d4edda';
            msgDiv.style.color = '#155724';
        } else if (type === 'warning') {
            msgDiv.style.background = '#fff3cd';
            msgDiv.style.color = '#856404';
        } else if (type === 'error') {
            msgDiv.style.background = '#f8d7da';
            msgDiv.style.color = '#721c24';
        } else {
            msgDiv.style.background = '#d1ecf1';
            msgDiv.style.color = '#0c5460';
        }
        
        const timestamp = new Date().toLocaleTimeString();
        msgDiv.textContent = `[${timestamp}] ${message}`;
        statusMessages.appendChild(msgDiv);
        
        // Auto-scroll to bottom
        statusMessages.parentElement.scrollTop = statusMessages.parentElement.scrollHeight;
    }
    
    eventSource.addEventListener('progress', function(e) {
        const data = JSON.parse(e.data);
        progressBar.style.width = data.percent + '%';
        progressText.textContent = data.percent + '%';
        addStatusMessage(data.message, data.type || 'info');
    });
    
    eventSource.addEventListener('complete', function(e) {
        const data = JSON.parse(e.data);
        progressBar.style.width = '100%';
        progressText.textContent = '100%';
        completionText.textContent = data.message;
        completionMessage.style.display = 'block';
        eventSource.close();
    });
    
    eventSource.addEventListener('error', function(e) {
        if (e.data) {
            const data = JSON.parse(e.data);
            errorText.textContent = data.message;
            errorMessage.style.display = 'block';
        } else {
            errorText.textContent = 'Connection lost. Please try again.';
            errorMessage.style.display = 'block';
        }
        eventSource.close();
    });
    
    // Initial message
    addStatusMessage('Initializing search...', 'info');
</script>

{% endblock %}
