{% extends "base.html" %}

{% block title %}Cover Letter - {{ job.title }}{% endblock %}

{% block content %}
<div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 style="color: white; margin: 0;">âœ… Cover Letter Generated!</h2>
            <p style="margin-top: 0.5rem; opacity: 0.9;">
                {{ result.style }} style in {{ result.language }}
            </p>
        </div>
        <button onclick="copyToClipboard()" class="btn" style="background: white; color: #667eea;">
            ğŸ“‹ Copy to Clipboard
        </button>
    </div>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
        <div>
            <h3 style="margin: 0;">{{ job.title }}</h3>
            <p style="color: #666; margin-top: 0.25rem;">{{ job.company }} â€¢ {{ job.location }}</p>
        </div>
    </div>

    <!-- Edit mode indicator -->
    <p id="editModeIndicator" style="font-size: 0.875rem; color: #ffc107; margin: 0.5rem 0; display: none;">
        âœï¸ <strong>Edit Mode:</strong> Click anywhere in the cover letter to edit. Save when done.
    </p>

    <!-- Cover letter body -->
    <div id="coverLetterText"
         style="white-space: pre-wrap; line-height: 1.8; font-size: 1.05rem; color: #333;
                font-family: Georgia, serif; background: #f8f9fa; border: 1px solid #e0e0e0;
                border-radius: 8px; padding: 1.5rem; margin-top: 1rem;">{{ result.cover_letter }}</div>
</div>

<!-- Action buttons -->
<div class="card">
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button id="editBtn" onclick="toggleEditMode()" class="btn" style="background: #ffc107; color: #000;">
            âœï¸ Edit
        </button>
        <button id="saveBtn" onclick="saveCoverLetter()" class="btn" style="background: #28a745;">
            ğŸ’¾ Save
        </button>
        <button id="cancelBtn" onclick="cancelEdit()" class="btn btn-secondary" style="display: none;">
            Cancel Edits
        </button>
        <button onclick="copyToClipboard()" class="btn" style="background: #17a2b8;">
            ğŸ“‹ Copy to Clipboard
        </button>
        <button onclick="downloadAsText()" class="btn" style="background: #007bff;">
            ğŸ“¥ Download .txt
        </button>
        <button onclick="window.print()" class="btn" style="background: #6c757d;">
            ğŸ–¨ï¸ Print
        </button>
        <a href="{{ url_for('generate_cover_letter_page', job_id=job.id) }}" class="btn" style="background: #ffc107; color: #000;">
            ğŸ”„ Generate Another
        </a>
        <a href="{{ url_for('job_detail', job_id=job.id) }}" class="btn btn-secondary">
            â† Back to Job
        </a>
    </div>
</div>

<!-- Save confirmation toast -->
<div id="saveNotification" style="display: none; position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;">
    âœ… Cover letter saved! Find it in <strong>Resumes & Cover Letters</strong>.
</div>

<div id="copyNotification" style="display: none; position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;">
    âœ… Copied to clipboard!
</div>

<script>
const jobId = {{ job.id }};
let isEditMode = false;
let originalText = document.getElementById('coverLetterText').innerText;

function toggleEditMode() {
    isEditMode = !isEditMode;
    const content = document.getElementById('coverLetterText');
    const editBtn = document.getElementById('editBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const indicator = document.getElementById('editModeIndicator');

    if (isEditMode) {
        content.contentEditable = 'true';
        content.style.border = '2px solid #ffc107';
        content.style.background = '#fffdf0';
        editBtn.style.display = 'none';
        cancelBtn.style.display = 'inline-block';
        indicator.style.display = 'block';
        content.focus();
    } else {
        content.contentEditable = 'false';
        content.style.border = '1px solid #e0e0e0';
        content.style.background = '#f8f9fa';
        editBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'none';
        indicator.style.display = 'none';
    }
}

function cancelEdit() {
    if (confirm('Discard all changes and restore original?')) {
        document.getElementById('coverLetterText').innerText = originalText;
        if (isEditMode) toggleEditMode();
    }
}

async function saveCoverLetter() {
    const text = document.getElementById('coverLetterText').innerText;

    try {
        const response = await fetch(`/api/save-cover-letter/${jobId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cover_letter_text: text })
        });

        const result = await response.json();

        if (result.success) {
            // Update original so Cancel won't revert to pre-save state
            originalText = text;

            // Exit edit mode if active
            if (isEditMode) toggleEditMode();

            // Show toast
            const toast = document.getElementById('saveNotification');
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        } else {
            alert('Failed to save: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error saving cover letter: ' + error.message);
    }
}

function copyToClipboard() {
    const text = document.getElementById('coverLetterText').innerText;
    navigator.clipboard.writeText(text).then(function() {
        showNotification('copyNotification');
    }, function(err) {
        alert('Failed to copy: ' + err);
    });
}

function showNotification(id) {
    const el = document.getElementById(id);
    el.style.display = 'block';
    setTimeout(function() { el.style.display = 'none'; }, 2000);
}

function downloadAsText() {
    const text = document.getElementById('coverLetterText').innerText;
    const blob = new Blob([text], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cover_letter_{{ job.company|replace(" ", "_") }}_{{ job.title|replace(" ", "_") }}.txt';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

// Print styles
window.onbeforeprint = function() {
    document.body.style.background = 'white';
    document.querySelectorAll('.card').forEach(card => {
        if (!card.contains(document.getElementById('coverLetterText'))) {
            card.style.display = 'none';
        }
    });
};

window.onafterprint = function() {
    document.body.style.background = '';
    document.querySelectorAll('.card').forEach(card => {
        card.style.display = '';
    });
};
</script>

<style>
@media print {
    .navbar, .btn, button, a.btn {
        display: none !important;
    }
    #coverLetterText {
        font-size: 12pt;
        line-height: 1.6;
        color: black;
        border: none !important;
        background: white !important;
        padding: 0 !important;
    }
    .card {
        box-shadow: none;
        border: none;
        padding: 0;
    }
}
</style>

{% endblock %}
